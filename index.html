<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vortex Bypasser</title>
  <!-- styles.css served from /public/styles.css -->
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <!-- Animated Background Elements -->
  <div class="animated-background" aria-hidden="true">
    <div class="background-grid"></div>
    <div class="floating-orb orb-1"></div>
    <div class="floating-orb orb-2"></div>
    <div class="floating-orb orb-3"></div>
    <div class="floating-orb orb-4"></div>
    <div class="floating-particle particle-1"></div>
    <div class="floating-particle particle-2"></div>
    <div class="floating-particle particle-3"></div>
    <div class="floating-particle particle-4"></div>
    <div class="floating-particle particle-5"></div>
    <div class="floating-particle particle-6"></div>
  </div>

  <!-- Title: now side-by-side -->
  <header class="site-header" role="banner">
    <h1 class="title">
      <span class="title-main">Vortex</span>
      <span class="title-divider"> </span>
      <span class="title-sub">Bypasser</span>
    </h1>
  </header>

  <div class="container" role="main">
    <!-- Input wrapper with animated icon and micro-interactions -->
    <div class="input-wrapper">
      <svg class="input-icon" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
        <path fill="currentColor" d="M12 2a10 10 0 100 20 10 10 0 000-20zm1 6h4v2h-4V8zm-6 7h12v2H7v-2zm6-4h4v2h-4v-2z"/>
      </svg>
      <input id="urlInput" type="text" placeholder="Enter URL..." autocomplete="off" />
      <div class="input-animated-bar" aria-hidden="true"></div>
    </div>

    <button id="bypassBtn" disabled>BYPASS</button>

    <div class="toggle-container" aria-hidden="false">
      <label class="switch" title="Auto Redirect">
        <input type="checkbox" id="autoRedirect" />
        <span class="slider"></span>
      </label>
      <p class="toggle-label">Auto Redirect</p>
    </div>

    <div class="result-box" id="resultBox" aria-live="polite">
      <div id="resultText">Ready — enter a url</div>
      <div id="timer" class="timer">0:00</div>
    </div>

    <div class="supported-box" aria-hidden="false">
      <h3>Supported Links</h3>
      <ul>
        <li>https://work.ink</li>
        <li>https://linkvertise</li>
        <li>https://link-unlocker.com</li>
        <li>https://pandadevelopment.net</li>
        <li>https://keyrblx.com</li>
        <li>https://krnl.cat</li>
      </ul>
    </div>

    <div class="buttons">
      <a href="https://discord.gg/PCQvUSUEsE" target="_blank" rel="noopener" class="btn">Join Discord</a>
      <a href="https://discord.com/oauth2/authorize?client_id=1355400268103290910" target="_blank" rel="noopener" class="btn">Invite Bot</a>
    </div>

    <p class="footer">Powered by Trw.lat</p>
  </div>

  <!-- Client logic: uses /api/key-check and /api/bypass (server-side) -->
  <script type="module">
    const urlInput = document.getElementById("urlInput");
    const bypassBtn = document.getElementById("bypassBtn");
    const resultText = document.getElementById("resultText");
    const timerEl = document.getElementById("timer");
    const autoRedirectToggle = document.getElementById("autoRedirect");

    let timerInterval = null;
    let startTs = null;

    // Format to m:ss (example: 0:05, 1:23). Minutes do NOT have forced leading zeros.
    function formatElapsed(ms) {
      const totalMs = Math.max(0, Math.floor(ms));
      const minutes = Math.floor(totalMs / 60000);
      const seconds = Math.floor((totalMs % 60000) / 1000);
      return `${String(minutes)}:${String(seconds).padStart(2, '0')}`;
    }

    function startTimer() {
      stopTimer();
      startTs = performance.now();
      timerEl.textContent = formatElapsed(0);
      timerInterval = setInterval(() => {
        const elapsed = performance.now() - startTs;
        timerEl.textContent = formatElapsed(elapsed);
      }, 100); // 10 updates per second is enough for m:ss
    }

    function stopTimer() {
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
      startTs = null;
    }

    function showInfo(msg) {
      resultText.style.color = "#a8d8ff";
      resultText.textContent = msg;
    }
    function showError(msg) {
      resultText.style.color = "#ff6b6b";
      resultText.textContent = "Error: " + msg;
    }
    function setProcessing(on) {
      bypassBtn.disabled = on;
      bypassBtn.style.opacity = on ? "0.8" : "1";
      bypassBtn.textContent = on ? "Processing..." : "BYPASS";
    }

    async function checkKeyConfigured() {
      try {
        const res = await fetch('/api/key-check', { method: 'GET', cache: 'no-store' });
        if (!res.ok) {
          showError(`Key-check endpoint returned ${res.status}`);
          bypassBtn.disabled = true;
          return false;
        }
        const data = await res.json();
        if (data && data.ok && data.configured) {
          showInfo("Ready — enter a url");
          bypassBtn.disabled = false;
          return true;
        } else {
          showError("VORTEX_API_KEY is not configured on the server. Set it in Vercel Project → Settings → Environment Variables.");
          bypassBtn.disabled = true;
          return false;
        }
      } catch (err) {
        showError("Cannot reach key-check endpoint: " + (err.message || err));
        bypassBtn.disabled = true;
        return false;
      }
    }

    (async () => {
      // initial check
      await checkKeyConfigured();
    })();

    async function handleBypass() {
      // re-check key before running
      const ok = await checkKeyConfigured();
      if (!ok) return;

      const url = urlInput.value.trim();
      if (!url) {
        showError("Please enter a URL.");
        return;
      }

      const proxyUrl = `/api/bypass?url=${encodeURIComponent(url)}`;

      setProcessing(true);
      showInfo("Starting bypass...");
      startTimer();

      try {
        const res = await fetch(proxyUrl, { method: 'GET' });
        const text = await res.text().catch(()=>null);
        let body = null;
        try { body = text ? JSON.parse(text) : null; } catch (e) { body = null; }

        stopTimer();

        if (!res.ok) {
          const errMsg = (body && body.error) ? body.error : `Proxy returned ${res.status}`;
          showError(errMsg);
          setProcessing(false);
          return;
        }

        if (body && body.ok && body.result) {
          if (body.elapsedMs != null) {
            timerEl.textContent = formatElapsed(body.elapsedMs);
          }
          showInfo(body.result);
          if (autoRedirectToggle.checked) {
            setTimeout(()=> window.location.href = body.result, 200);
          }
        } else {
          showError((body && body.error) ? body.error : 'Unexpected proxy response');
        }
      } catch (err) {
        stopTimer();
        showError(err.message || String(err));
      } finally {
        setProcessing(false);
      }
    }

    urlInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        handleBypass();
      }
    });

    bypassBtn.addEventListener('click', handleBypass);

    // small nicety: focus input on load
    window.addEventListener('load', () => {
      try { urlInput.focus(); } catch(e) {}
    });

    // expose for debugging
    window._vb = { checkKeyConfigured, handleBypass, startTimer, stopTimer };
  </script>

  <!-- Vercel Analytics & Speed Insights (optional) -->
  <script defer src="https://cdn.vercel-insights.com/v1/script.analytics.js"></script>
  <script defer src="https://cdn.vercel-insights.com/v1/script.debug.js"></script>
</body>
</html>
