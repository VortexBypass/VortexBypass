<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>VortexBypass</title>

  <!-- font -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- main stylesheet -->
  <link rel="stylesheet" href="/styles.css" />

  <!-- minimal fallback to avoid totally broken page if styles fail -->
  <style>
    html,body{min-height:100%}
    body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;padding:18px;background:#0b0f24;color:#fff}
  </style>
</head>
<body>
  <!-- background orbs/particles (grid removed) -->
  <div class="animated-background" aria-hidden="true">
    <div class="floating-orb orb-1"></div>
    <div class="floating-orb orb-2"></div>
    <div class="floating-orb orb-3"></div>
    <div class="floating-orb orb-4"></div>
    <div class="floating-particle particle-1"></div>
    <div class="floating-particle particle-2"></div>
    <div class="floating-particle particle-3"></div>
    <div class="floating-particle particle-4"></div>
    <div class="floating-particle particle-5"></div>
    <div class="floating-particle particle-6"></div>
  </div>

  <!-- Header: TITLE only (logo removed) -->
  <header class="site-header" role="banner">
    <h1 class="site-title" aria-label="VortexBypass">üå™Ô∏è <span class="site-title-text">VortexBypass</span></h1>
  </header>

  <main class="container" role="main">
    <!-- input wrapper (icon removed) -->
    <div class="input-wrapper">
      <div class="input-stack" style="flex:1">
        <input id="urlInput" type="text" placeholder="Enter URL..." autocomplete="off" />
        <div class="input-animated-bar" aria-hidden="true"></div>
      </div>
    </div>

    <!-- BYPASS button moved down and z-indexed -->
    <div class="button-row">
      <button id="bypassBtn" disabled>BYPASS</button>
    </div>

    <!-- Auto Redirect newly styled toggle -->
    <div class="toggle-container" aria-hidden="false">
      <label class="toggle-pill" title="Auto Redirect">
        <input type="checkbox" id="autoRedirect" />
        <span class="toggle-track" aria-hidden="true">
          <span class="toggle-thumb"></span>
        </span>
      </label>
      <p class="toggle-label">Auto Redirect</p>
    </div>

    <div class="result-box" id="resultBox" aria-live="polite">
      <div id="resultText">Ready ‚Äî enter a url</div>
      <div id="timer" class="timer">0:00</div>
    </div>

    <div class="supported-box" aria-hidden="false">
      <h3>Supported Links</h3>
      <ul>
        <li>https://work.ink</li>
        <li>https://linkvertise</li>
        <li>https://link-unlocker.com</li>
        <li>https://pandadevelopment.net</li>
        <li>https://keyrblx.com</li>
        <li>https://krnl.cat</li>
      </ul>
    </div>

    <div class="buttons">
      <a href="https://discord.gg/PCQvUSUEsE" target="_blank" rel="noopener" class="btn">Join Discord</a>
      <a href="https://discord.com/oauth2/authorize?client_id=1355400268103290910" target="_blank" rel="noopener" class="btn">Invite Bot</a>
    </div>

    <p class="footer">Powered by Trw.lat</p>
  </main>

  <script type="module">
    const urlInput = document.getElementById("urlInput");
    const bypassBtn = document.getElementById("bypassBtn");
    const resultText = document.getElementById("resultText");
    const timerEl = document.getElementById("timer");
    const autoRedirectToggle = document.getElementById("autoRedirect");

    let timerInterval = null;
    let startTs = null;

    // Format to m:ss (minutes without leading zero)
    function formatElapsed(ms) {
      const totalMs = Math.max(0, Math.floor(ms));
      const minutes = Math.floor(totalMs / 60000);
      const seconds = Math.floor((totalMs % 60000) / 1000);
      return `${String(minutes)}:${String(seconds).padStart(2, '0')}`;
    }

    function startTimer() {
      stopTimer();
      startTs = performance.now();
      timerEl.textContent = formatElapsed(0);
      timerInterval = setInterval(() => {
        const elapsed = performance.now() - startTs;
        timerEl.textContent = formatElapsed(elapsed);
      }, 100);
    }

    function stopTimer() {
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
      startTs = null;
    }

    function showInfo(msg) {
      resultText.style.color = "#a8d8ff";
      resultText.textContent = msg;
    }
    function showError(msg) {
      resultText.style.color = "#ff6b6b";
      resultText.textContent = "Error: " + msg;
    }
    function setProcessing(on) {
      bypassBtn.disabled = on;
      bypassBtn.style.opacity = on ? "0.8" : "1";
      bypassBtn.textContent = on ? "Processing..." : "BYPASS";
    }

    async function checkKeyConfigured() {
      try {
        const res = await fetch('/api/key-check', { method: 'GET', cache: 'no-store' });

        // If endpoint missing (404) enable UI gracefully and avoid showing red scary error.
        if (res.status === 404) {
          console.warn('key-check returned 404 ‚Äî endpoint not deployed or wrong path.');
          // Friendly neutral notice (not red) so users aren't alarmed
          resultText.style.color = "#c0dfff";
          resultText.textContent = "Key-check not found ‚Äî running in offline mode";
          bypassBtn.disabled = false; // allow testing while server endpoint absent
          return false;
        }

        if (!res.ok) {
          showError(`Key-check endpoint returned ${res.status}`);
          bypassBtn.disabled = true;
          return false;
        }

        const data = await res.json();
        if (data && data.ok && data.configured) {
          showInfo("Ready ‚Äî enter a url");
          bypassBtn.disabled = false;
          return true;
        } else {
          showError("VORTEX_API_KEY is not configured on the server. Set it in your environment.");
          bypassBtn.disabled = true;
          return false;
        }
      } catch (err) {
        // network failure or CORS etc ‚Äî surface the message but allow testing if desired
        console.error('checkKeyConfigured error', err);
        resultText.style.color = "#c0dfff";
        resultText.textContent = "Key-check unavailable ‚Äî running in offline mode";
        bypassBtn.disabled = false;
        return false;
      }
    }

    (async () => {
      await checkKeyConfigured();
      try { urlInput.focus(); } catch(e){}
    })();

    async function handleBypass() {
      // Attempt re-check but continue if check fails
      await checkKeyConfigured();

      const url = urlInput.value.trim();
      if (!url) { showError("Please enter a URL."); return; }

      const proxyUrl = `/api/bypass?url=${encodeURIComponent(url)}`;

      setProcessing(true);
      showInfo("Starting bypass...");
      startTimer();

      try {
        const res = await fetch(proxyUrl, { method: 'GET' });
        const text = await res.text().catch(()=>null);
        let body = null;
        try { body = text ? JSON.parse(text) : null; } catch(e) { body = null; }

        stopTimer();

        if (!res.ok) {
          const errMsg = (body && body.error) ? body.error : `Proxy returned ${res.status}`;
          showError(errMsg);
          setProcessing(false);
          return;
        }

        if (body && body.ok && body.result) {
          if (body.elapsedMs != null) timerEl.textContent = formatElapsed(body.elapsedMs);
          showInfo(body.result);
          if (autoRedirectToggle.checked) setTimeout(()=> window.location.href = body.result, 200);
        } else {
          showError((body && body.error) ? body.error : 'Unexpected proxy response');
        }
      } catch (err) {
        stopTimer();
        showError(err.message || String(err));
      } finally {
        setProcessing(false);
      }
    }

    urlInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') { e.preventDefault(); handleBypass(); }
    });
    bypassBtn.addEventListener('click', handleBypass);
    window._vb = { checkKeyConfigured, handleBypass, startTimer, stopTimer };
  </script>

  <!-- optional analytics -->
  <script defer src="https://cdn.vercel-insights.com/v1/script.analytics.js"></script>
</body>
</html>
