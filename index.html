<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vortex Bypasser</title>

  <!-- If you prefer build-time injection, have your build replace %VORTEX_API_KEY% with the env var:
       <meta name="vortex-api-key" content="%VORTEX_API_KEY%">
       (Many static hosts allow injecting env values at build time.)
  -->
  <link rel="stylesheet" href="styles.css" />
  <script src="https://www.google.com/recaptcha/api.js" async defer></script>
</head>
<body>
  <h1>üå™Ô∏è Vortex Bypasser</h1>

  <div class="container">
    <input id="urlInput" type="text" placeholder="Enter URL..." />

    <button id="bypassBtn">Bypass</button>

    <div class="toggle-container">
      <label class="switch">
        <input type="checkbox" id="autoRedirect" />
        <span class="slider"></span>
      </label>
      <p class="toggle-label">Auto Redirect</p>
    </div>

    <div class="result-box" id="resultBox">Result will appear here...</div>

    <div class="supported-box">
      <h3>Supported Links</h3>
      <ul>
        <li>https://work.ink</li>
        <li>https://linkvertise</li>
        <li>https://link-unlocker.com</li>
        <li>https://pandadevelopment.net</li>
        <li>https://keyrblx.com</li>
        <li>https://krnl.cat</li>
      </ul>
    </div>

    <div class="buttons">
      <a href="https://discord.gg/PCQvUSUEsE" target="_blank" class="btn">Join Discord</a>
      <a href="https://discord.com/oauth2/authorize?client_id=1355400268103290910" target="_blank" class="btn">Invite Bot</a>
    </div>

    <p class="footer">Powered by Trw.lat</p>
  </div>

  <script>
    const resultBox = document.getElementById("resultBox");
    const bypassBtn = document.getElementById("bypassBtn");
    const autoRedirectToggle = document.getElementById("autoRedirect");

    const generalAPIs = ["work.ink", "linkvertise", "link-unlocker.com"];
    const v2APIs = ["pandadevelopment.net", "keyrblx.com", "krnl.cat"];

    // Try to obtain API key securely:
    // 1) First try a serverless endpoint /api/key which should return JSON: { "key": "<your-key>" }
    //    (Create a small serverless function on Vercel that reads process.env.VORTEX_API_KEY and returns it.)
    // 2) Fallback to a build-time meta tag if you inject the key during build.
    async function getApiKey() {
      // attempt serverless endpoint
      try {
        const res = await fetch('/api/key', { cache: 'no-store' });
        if (res.ok) {
          const j = await res.json();
          if (j && j.key) return j.key;
        }
      } catch (e) {
        // ignore and try meta fallback
      }

      // fallback: meta tag injected at build-time
      const meta = document.querySelector('meta[name="vortex-api-key"]');
      if (meta && meta.content) return meta.content;

      // not found
      resultBox.textContent = "API key not configured. Please set VORTEX_API_KEY in Vercel and expose it via /api/key or a build-time meta tag.";
      throw new Error("API key not found");
    }

    async function handleBypass() {
      const url = document.getElementById("urlInput").value.trim();
      if (!url) {
        resultBox.textContent = "Please enter a URL.";
        return;
      }

      let apiUrl = "";
      let useV2 = false;

      if (generalAPIs.some(d => url.includes(d))) {
        apiUrl = `https://trw.lat/api/bypass?url=${encodeURIComponent(url)}`;
      } else if (v2APIs.some(d => url.includes(d))) {
        apiUrl = `https://trw.lat/api/v2/bypass?url=${encodeURIComponent(url)}`;
        useV2 = true;
      } else {
        resultBox.textContent = "Unsupported URL.";
        return;
      }

      resultBox.textContent = "Processing...";

      let API_KEY;
      try {
        API_KEY = await getApiKey();
      } catch (err) {
        // getApiKey already set user-facing message
        return;
      }

      try {
        const res = await fetch(apiUrl, { headers: { "x-api-key": API_KEY } });
        const data = await res.json();

        if (useV2 && data.ThreadID) {
          resultBox.textContent = "Task started ‚Äî polling for completion...";
          await pollThread(data.ThreadID, API_KEY);
        } else if (data.result) {
          resultBox.textContent = data.result;
          if (autoRedirectToggle.checked) window.location.href = data.result;
        } else {
          resultBox.textContent = "Unexpected response.";
        }
      } catch (err) {
        resultBox.textContent = "Error: " + err.message;
      }
    }

    async function pollThread(threadId, apiKey) {
      const pollUrl = `https://trw.lat/api/v2/threadcheck?id=${threadId}`;
      let attempts = 0;
      const maxAttempts = 120; // as requested: 120 tries
      const delayMs = 500;     // 0.5s between polls

      while (attempts < maxAttempts) {
        attempts++;
        try {
          const res = await fetch(pollUrl, { headers: { "x-api-key": apiKey } });
          const data = await res.json();

          if (data.status === "Done" && data.result) {
            resultBox.textContent = data.result;
            if (autoRedirectToggle.checked) window.location.href = data.result;
            return;
          }
        } catch (err) {
          resultBox.textContent = "Polling error: " + err.message;
          return;
        }

        // wait 0.5s
        await new Promise(r => setTimeout(r, delayMs));
      }

      resultBox.textContent = "Timed out after 60 seconds ‚Äî no result received.";
    }

    bypassBtn.addEventListener("click", handleBypass);

    // optional: allow Enter key to trigger bypass
    document.getElementById('urlInput').addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        bypassBtn.click();
      }
    });
  </script>
</body>
</html>
