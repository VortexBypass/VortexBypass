<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vortex Bypasser</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="https://www.google.com/recaptcha/api.js" async defer></script>
</head>
<body>
  <h1>üå™Ô∏è Vortex Bypasser</h1>

  <div class="container">
    <input id="urlInput" type="text" placeholder="Enter URL..." />

    <button id="bypassBtn">
      <span class="btn-text">Bypass</span>
      <span class="timer" id="timer">0.0s</span>
    </button>

    <div class="toggle-container">
      <label class="switch">
        <input type="checkbox" id="autoRedirect" />
        <span class="slider"></span>
      </label>
      <p>Auto Redirect</p>
    </div>

    <div class="result-box" id="resultBox">Result will appear here...</div>

    <div class="supported-box">
      <h3>Supported Links</h3>
      <ul>
        <li>https://work.ink</li>
        <li>https://linkvertise</li>
        <li>https://link-unlocker.com</li>
        <li>https://pandadevelopment.net</li>
        <li>https://keyrblx.com</li>
        <li>https://krnl.cat</li>
      </ul>
    </div>

    <div class="buttons">
      <a href="https://discord.gg/PCQvUSUEsE" target="_blank" class="btn">Join Discord</a>
      <a href="https://discord.com/oauth2/authorize?client_id=1355400268103290910" target="_blank" class="btn">Invite Bot</a>
    </div>

    <p class="footer">Powered by Trw.lat</p>
  </div>

  <script>
    // API key will be handled via environment variables
    const API_KEY = "<?= process.env.VORTEX_API_KEY ?>";
    const resultBox = document.getElementById("resultBox");
    const bypassBtn = document.getElementById("bypassBtn");
    const btnText = document.querySelector('.btn-text');
    const timerElement = document.getElementById('timer');
    const autoRedirectToggle = document.getElementById("autoRedirect");

    let timerInterval;
    let startTime;

    const generalAPIs = ["work.ink", "linkvertise", "link-unlocker.com"];
    const v2APIs = ["pandadevelopment.net", "keyrblx.com", "krnl.cat"];

    function startTimer() {
      startTime = Date.now();
      clearInterval(timerInterval);
      timerInterval = setInterval(() => {
        const elapsed = (Date.now() - startTime) / 1000;
        timerElement.textContent = `${elapsed.toFixed(1)}s`;
      }, 100);
    }

    function stopTimer() {
      clearInterval(timerInterval);
      const finalTime = ((Date.now() - startTime) / 1000).toFixed(1);
      timerElement.textContent = `${finalTime}s`;
    }

    async function handleBypass() {
      const url = document.getElementById("urlInput").value.trim();
      if (!url) {
        resultBox.textContent = "Please enter a URL.";
        return;
      }

      let apiUrl = "";
      let useV2 = false;

      if (generalAPIs.some(d => url.includes(d))) {
        apiUrl = `https://trw.lat/api/bypass?url=${encodeURIComponent(url)}`;
      } else if (v2APIs.some(d => url.includes(d))) {
        apiUrl = `https://trw.lat/api/v2/bypass?url=${encodeURIComponent(url)}`;
        useV2 = true;
      } else {
        resultBox.textContent = "Unsupported URL.";
        return;
      }

      // Start timer and update UI
      startTimer();
      resultBox.textContent = "Processing...";
      bypassBtn.disabled = true;
      btnText.textContent = "Bypassing";

      try {
        const res = await fetch(apiUrl, { headers: { "x-api-key": API_KEY } });
        const data = await res.json();

        if (useV2 && data.ThreadID) {
          resultBox.textContent = "Task started ‚Äî polling for completion...";
          await pollThread(data.ThreadID);
        } else if (data.result) {
          stopTimer();
          resultBox.textContent = data.result;
          if (autoRedirectToggle.checked) window.location.href = data.result;
        } else {
          stopTimer();
          resultBox.textContent = "Unexpected response.";
        }
      } catch (err) {
        stopTimer();
        resultBox.textContent = "Error: " + err.message;
      } finally {
        bypassBtn.disabled = false;
        btnText.textContent = "Bypass";
      }
    }

    async function pollThread(threadId) {
      const pollUrl = `https://trw.lat/api/v2/threadcheck?id=${threadId}`;
      let attempts = 0;
      const maxAttempts = 120;

      while (attempts < maxAttempts) {
        attempts++;
        try {
          const res = await fetch(pollUrl, { headers: { "x-api-key": API_KEY } });
          const data = await res.json();

          if (data.status === "Done" && data.result) {
            stopTimer();
            resultBox.textContent = data.result;
            if (autoRedirectToggle.checked) window.location.href = data.result;
            return;
          }
        } catch (err) {
          stopTimer();
          resultBox.textContent = "Polling error: " + err.message;
          return;
        }

        await new Promise(r => setTimeout(r, 500));
      }

      stopTimer();
      resultBox.textContent = "Timed out after 60 seconds ‚Äî no result received.";
    }

    bypassBtn.addEventListener("click", handleBypass);
  </script>

</body>
</html>
