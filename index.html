<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vortex Bypasser</title>

  <!-- Google font (fallback-safe) -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- main stylesheet -->
  <link rel="stylesheet" href="/styles.css" />

  <!-- tiny safe default style to avoid completely broken UX if styles.css 404s -->
  <style>
    html,body{min-height:100%}
    body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;padding:20px;background:#0b0f24;color:#fff}
    a{color:inherit}
  </style>
</head>
<body>
  <!-- Animated Background Elements (grid removed) -->
  <div class="animated-background" aria-hidden="true">
    <div class="floating-orb orb-1"></div>
    <div class="floating-orb orb-2"></div>
    <div class="floating-orb orb-3"></div>
    <div class="floating-orb orb-4"></div>
    <div class="floating-particle particle-1"></div>
    <div class="floating-particle particle-2"></div>
    <div class="floating-particle particle-3"></div>
    <div class="floating-particle particle-4"></div>
    <div class="floating-particle particle-5"></div>
    <div class="floating-particle particle-6"></div>
  </div>

  <!-- Header: logo + inline title + emoji -->
  <header class="site-header" role="banner">
    <div class="logo-title">
      <img src="/images/logo.png" alt="logo" class="site-logo" id="siteLogo" />
      <h1 class="title" aria-label="Vortex Bypasser">
        <span class="title-emoji" aria-hidden="true">üå™Ô∏è</span>
        <span class="title-main">Vortex</span>
        <span class="title-divider"> </span>
        <span class="title-sub">Bypasser</span>
      </h1>
    </div>
  </header>

  <main class="container" role="main">
    <!-- Input wrapper: ICON REMOVED per request (circled element gone) -->
    <div class="input-wrapper">
      <div class="input-stack" style="flex:1">
        <input id="urlInput" type="text" placeholder="Enter URL..." autocomplete="off" />
        <div class="input-animated-bar" aria-hidden="true"></div>
      </div>
    </div>

    <button id="bypassBtn" disabled>BYPASS</button>

    <div class="toggle-container" aria-hidden="false">
      <label class="switch" title="Auto Redirect">
        <input type="checkbox" id="autoRedirect" />
        <span class="slider"></span>
      </label>
      <p class="toggle-label">Auto Redirect</p>
    </div>

    <div class="result-box" id="resultBox" aria-live="polite">
      <div id="resultText">Ready ‚Äî enter a url</div>
      <div id="timer" class="timer">0:00</div>
    </div>

    <div class="supported-box" aria-hidden="false">
      <h3>Supported Links</h3>
      <ul>
        <li>https://work.ink</li>
        <li>https://linkvertise</li>
        <li>https://link-unlocker.com</li>
        <li>https://pandadevelopment.net</li>
        <li>https://keyrblx.com</li>
        <li>https://krnl.cat</li>
      </ul>
    </div>

    <div class="buttons">
      <a href="https://discord.gg/PCQvUSUEsE" target="_blank" rel="noopener" class="btn">Join Discord</a>
      <a href="https://discord.com/oauth2/authorize?client_id=1355400268103290910" target="_blank" rel="noopener" class="btn">Invite Bot</a>
    </div>

    <p class="footer">Powered by Trw.lat</p>

    <!-- Optional: Before / After comparison (keeps same functionality) -->
    <section id="compareSection" class="compare-section" aria-hidden="true">
      <h3 class="compare-title">Design: before ‚Üí after</h3>
      <div class="compare-wrap">
        <img id="beforeImg" class="compare-img before" src="/images/before.jpg" alt="Before design" />
        <div class="after-wrap">
          <img id="afterImg" class="compare-img after" src="/images/after.jpg" alt="After design" />
          <div id="slider" class="compare-slider" aria-hidden="true"></div>
        </div>
      </div>
      <p class="compare-note">Drop `before.jpg` and `after.jpg` into `/public/images/` ‚Äî file names are case sensitive on many hosts.</p>
    </section>
  </main>

  <!-- Client logic: uses /api/key-check and /api/bypass (server-side) -->
  <script type="module">
    const urlInput = document.getElementById("urlInput");
    const bypassBtn = document.getElementById("bypassBtn");
    const resultText = document.getElementById("resultText");
    const timerEl = document.getElementById("timer");
    const autoRedirectToggle = document.getElementById("autoRedirect");
    const compareSection = document.getElementById('compareSection');
    const beforeImg = document.getElementById('beforeImg');
    const afterImg = document.getElementById('afterImg');

    let timerInterval = null;
    let startTs = null;

    // Format to m:ss (example: 0:05, 1:23). Minutes do NOT have forced leading zeros.
    function formatElapsed(ms) {
      const totalMs = Math.max(0, Math.floor(ms));
      const minutes = Math.floor(totalMs / 60000);
      const seconds = Math.floor((totalMs % 60000) / 1000);
      return `${String(minutes)}:${String(seconds).padStart(2, '0')}`;
    }

    function startTimer() {
      stopTimer();
      startTs = performance.now();
      timerEl.textContent = formatElapsed(0);
      timerInterval = setInterval(() => {
        const elapsed = performance.now() - startTs;
        timerEl.textContent = formatElapsed(elapsed);
      }, 100); // 10 updates/sec
    }

    function stopTimer() {
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
      startTs = null;
    }

    function showInfo(msg) {
      resultText.style.color = "#a8d8ff";
      resultText.textContent = msg;
    }
    function showError(msg) {
      resultText.style.color = "#ff6b6b";
      resultText.textContent = "Error: " + msg;
    }
    function setProcessing(on) {
      bypassBtn.disabled = on;
      bypassBtn.style.opacity = on ? "0.8" : "1";
      bypassBtn.textContent = on ? "Processing..." : "BYPASS";
    }

    async function checkKeyConfigured() {
      try {
        const res = await fetch('/api/key-check', { method: 'GET', cache: 'no-store' });
        if (!res.ok) {
          // keep the visible error message but make it a bit more actionable in the console
          console.warn('key-check returned', res.status);
          showError(`Key-check endpoint returned ${res.status}`);
          bypassBtn.disabled = true;
          return false;
        }
        const data = await res.json();
        if (data && data.ok && data.configured) {
          showInfo("Ready ‚Äî enter a url");
          bypassBtn.disabled = false;
          return true;
        } else {
          showError("VORTEX_API_KEY is not configured on the server. Set it in Vercel Project ‚Üí Settings ‚Üí Environment Variables.");
          bypassBtn.disabled = true;
          return false;
        }
      } catch (err) {
        showError("Cannot reach key-check endpoint: " + (err.message || err));
        bypassBtn.disabled = true;
        return false;
      }
    }

    (async () => {
      // initial check
      await checkKeyConfigured();

      // Compare images: hide compare if images not available
      function imgOK(imgEl) {
        return new Promise(resolve => {
          if (!imgEl) return resolve(false);
          if (imgEl.complete && imgEl.naturalWidth > 1) return resolve(true);
          imgEl.onload = () => resolve(imgEl.naturalWidth > 1);
          imgEl.onerror = () => resolve(false);
        });
      }
      const beforeOK = await imgOK(beforeImg);
      const afterOK = await imgOK(afterImg);
      if (beforeOK && afterOK) {
        compareSection.setAttribute('aria-hidden','false');
        compareSection.style.display = 'block';
        // simple draggable slider
        const slider = document.getElementById('slider');
        let dragging = false;
        const afterWrap = document.querySelector('.after-wrap');
        function setClip(x) {
          const rect = afterWrap.getBoundingClientRect();
          const pct = Math.max(0, Math.min(1, (x - rect.left) / rect.width));
          afterImg.style.clipPath = `inset(0 ${ (1 - pct) * 100 }% 0 0)`;
          slider.style.left = `${pct * 100}%`;
        }
        slider.addEventListener('pointerdown', (e) => { dragging = true; slider.setPointerCapture(e.pointerId); });
        window.addEventListener('pointerup', () => dragging = false);
        window.addEventListener('pointermove', (e) => { if (!dragging) return; setClip(e.clientX); });
        window.addEventListener('resize', () => setClip(window.innerWidth/2));
        setClip(window.innerWidth/2);
      } else {
        compareSection.style.display = 'none';
      }
    })();

    async function handleBypass() {
      // re-check key before running
      const ok = await checkKeyConfigured();
      if (!ok) return;

      const url = urlInput.value.trim();
      if (!url) {
        showError("Please enter a URL.");
        return;
      }

      const proxyUrl = `/api/bypass?url=${encodeURIComponent(url)}`;

      setProcessing(true);
      showInfo("Starting bypass...");
      startTimer();

      try {
        const res = await fetch(proxyUrl, { method: 'GET' });
        const text = await res.text().catch(()=>null);
        let body = null;
        try { body = text ? JSON.parse(text) : null; } catch (e) { body = null; }

        stopTimer();

        if (!res.ok) {
          const errMsg = (body && body.error) ? body.error : `Proxy returned ${res.status}`;
          showError(errMsg);
          setProcessing(false);
          return;
        }

        if (body && body.ok && body.result) {
          if (body.elapsedMs != null) {
            timerEl.textContent = formatElapsed(body.elapsedMs);
          }
          showInfo(body.result);
          if (autoRedirectToggle.checked) {
            setTimeout(()=> window.location.href = body.result, 200);
          }
        } else {
          showError((body && body.error) ? body.error : 'Unexpected proxy response');
        }
      } catch (err) {
        stopTimer();
        showError(err.message || String(err));
      } finally {
        setProcessing(false);
      }
    }

    urlInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        handleBypass();
      }
    });

    bypassBtn.addEventListener('click', handleBypass);

    // focus input on load
    window.addEventListener('load', () => { try { urlInput.focus(); } catch(e) {} });

    // expose for debugging
    window._vb = { checkKeyConfigured, handleBypass, startTimer, stopTimer };
  </script>

  <!-- Vercel Analytics (optional) -->
  <script defer src="https://cdn.vercel-insights.com/v1/script.analytics.js"></script>
  <script defer src="https://cdn.vercel-insights.com/v1/script.debug.js"></script>
</body>
</html>
