<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vortex Bypasser</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="https://www.google.com/recaptcha/api.js" async defer></script>
</head>
<body>
  <h1>üå™Ô∏è Vortex Bypasser</h1>

  <div class="container">
    <input id="urlInput" type="text" placeholder="Enter URL..." />

    <button id="bypassBtn" disabled>Bypass</button>

    <div class="toggle-container">
      <label class="switch">
        <input type="checkbox" id="autoRedirect" />
        <span class="slider"></span>
      </label>
      <p class="toggle-label">Auto Redirect</p>
    </div>

    <div class="result-box" id="resultBox">
      <div id="resultText">Checking configuration...</div>
      <div id="timer" class="timer" style="margin-top:8px; font-family:'Courier New', monospace; color:#cfe9ff;">00:00.000</div>
    </div>

    <div class="supported-box">
      <h3>Supported Links</h3>
      <ul>
        <li>https://work.ink</li>
        <li>https://linkvertise</li>
        <li>https://link-unlocker.com</li>
        <li>https://pandadevelopment.net</li>
        <li>https://keyrblx.com</li>
        <li>https://krnl.cat</li>
      </ul>
    </div>

    <div class="buttons">
      <a href="https://discord.gg/PCQvUSUEsE" target="_blank" class="btn">Join Discord</a>
      <a href="https://discord.com/oauth2/authorize?client_id=1355400268103290910" target="_blank" class="btn">Invite Bot</a>
    </div>

    <p class="footer">Powered by Trw.lat</p>
  </div>

  <script>
    // Elements
    const urlInput = document.getElementById("urlInput");
    const bypassBtn = document.getElementById("bypassBtn");
    const resultBox = document.getElementById("resultBox");
    const resultText = document.getElementById("resultText");
    const autoRedirectToggle = document.getElementById("autoRedirect");
    const timerEl = document.getElementById("timer");

    // State for timer
    let timerInterval = null;
    let startTs = null;

    function formatElapsed(ms) {
      const totalMs = Math.max(0, Math.floor(ms));
      const minutes = Math.floor(totalMs / 60000);
      const seconds = Math.floor((totalMs % 60000) / 1000);
      const millis = totalMs % 1000;
      return `${String(minutes).padStart(2,'0')}:${String(seconds).padStart(2,'0')}.${String(millis).padStart(3,'0')}`;
    }

    function startTimer() {
      stopTimer();
      startTs = performance.now();
      timerEl.textContent = formatElapsed(0);
      timerInterval = setInterval(() => {
        const elapsed = performance.now() - startTs;
        timerEl.textContent = formatElapsed(elapsed);
      }, 33);
    }

    function stopTimer() {
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
      startTs = null;
    }

    // UI helpers
    function showInfo(msg) {
      resultText.style.color = "#a8d8ff";
      resultText.textContent = msg;
    }
    function showError(msg) {
      resultText.style.color = "#ff6b6b";
      resultText.textContent = "Error: " + msg;
    }
    function setProcessing(on) {
      bypassBtn.disabled = on;
      bypassBtn.style.opacity = on ? "0.8" : "1";
      bypassBtn.textContent = on ? "Processing..." : "Bypass";
    }

    // Check key configuration without exposing it
    async function checkKeyConfigured() {
      try {
        const res = await fetch('/api/key-check', { method: 'GET', cache: 'no-store' });
        if (!res.ok) {
          showError(`Key-check endpoint returned ${res.status}`);
          bypassBtn.disabled = true;
          return false;
        }
        const data = await res.json();
        if (data && data.ok && data.configured) {
          // <-- changed message as requested:
          showInfo("Ready enter a url");
          bypassBtn.disabled = false;
          return true;
        } else {
          showError("VORTEX_API_KEY is not configured on the server. Set it in Vercel Project ‚Üí Settings ‚Üí Environment Variables.");
          bypassBtn.disabled = true;
          return false;
        }
      } catch (err) {
        showError("Cannot reach key-check endpoint: " + (err.message || err));
        bypassBtn.disabled = true;
        return false;
      }
    }

    // call check at startup
    (async () => {
      // initial UI
      resultText.textContent = "Checking configuration...";
      timerEl.textContent = "00:00.000";
      await checkKeyConfigured();
    })();

    // main bypass flow -> calls server-side proxy so key never reaches client
    async function handleBypass() {
      // Always re-check key-config just before calling (prevents accidental client-side bypass when env changed)
      const ok = await checkKeyConfigured();
      if (!ok) return;

      const url = urlInput.value.trim();
      if (!url) {
        showError("Please enter a URL.");
        return;
      }

      const proxyUrl = `/api/bypass?url=${encodeURIComponent(url)}`;

      setProcessing(true);
      showInfo("Starting bypass...");
      startTimer();

      try {
        const res = await fetch(proxyUrl, { method: 'GET' });
        const text = await res.text().catch(()=>null);
        let body = null;
        try { body = text ? JSON.parse(text) : null; } catch(e) { body = null; }

        if (!res.ok) {
          stopTimer();
          const errMsg = (body && body.error) ? body.error : `Proxy returned ${res.status}`;
          showError(errMsg);
          setProcessing(false);
          return;
        }

        if (body && body.ok && body.result) {
          stopTimer();
          // show server-provided elapsed if available, otherwise keep client timer value
          if (body.elapsedMs != null) {
            timerEl.textContent = formatElapsed(body.elapsedMs);
          }
          showInfo(body.result);
          // auto-redirect if requested
          if (autoRedirectToggle.checked) {
            setTimeout(() => window.location.href = body.result, 200);
          }
        } else {
          stopTimer();
          showError((body && body.error) ? body.error : 'Unexpected proxy response');
        }
      } catch (err) {
        stopTimer();
        showError(err.message || String(err));
      } finally {
        setProcessing(false);
      }
    }

    // keyboard enter to trigger
    urlInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        handleBypass();
      }
    });

    // click
    bypassBtn.addEventListener('click', handleBypass);

    // Optional: expose a manual re-check in console
    window._vb = {
      checkKeyConfigured,
      handleBypass,
      startTimer,
      stopTimer
    };
  </script>

  <!-- Vercel Analytics + Speed Insights (deferred) -->
  <script defer src="https://cdn.vercel-insights.com/v1/script.analytics.js"></script>
  <script defer src="https://cdn.vercel-insights.com/v1/script.debug.js"></script>
</body>
</html>
